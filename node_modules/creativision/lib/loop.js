require('./req');
require('./res');
require('./stream');

//注册全局流程
o2c.runtime.loop = function(req,res){
  //setencoding
  req.setEncoding("utf8");
  //内建API接口获取
  var req = o2c.runtime.req(req);
  var res = o2c.runtime.res(res);

  //req的body解析->管道函数->runtime.router
  //SOCKET的话，需要此处中断，下个版本补
  //需要加个SOCKET路由识别函数，注册SOCKET

  bodyparser(req,res);
};

//集
//stream流处理
function bodyparser (req,res){
  var data='';
  req.on('data',ondata);
  req.once('end',onend);
  req.once('error',error);
  req.once('close',cleanup);

  function ondata(d){
  	data+=d;
  };

  function onend(){
  	//真正的流处理
  	req = body(req,data);
  	o2c.runtime.router(req,res);
  	cleanup();
  };

  function error(err){
  	res.end(err);
  	cleanup();
  };

  function cleanup(){
  	req.removeListener('data',ondata);
  	req.removeListener('end',onend);
  	req.removeListener('error',error);
  	req.removeListener('close',cleanup);
  };
}

function body(req,data){
  //给用户一个自解析的API
  req.streamdata = data;
  //json流
  //xml流
  //form流

  return req;
}